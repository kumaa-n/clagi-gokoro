<div class="flex-1 px-4 py-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-start mb-8">
      <div>
        <h2 class="text-3xl text-primary font-semibold mb-6">レビュー一覧</h2>
        <p class="text-xl text-primary font-semibold mb-2"><%= @song.title %></p>
        <p class="text-primary">作曲：<%= @song.composer || "－" %></p>
        <p class="text-primary">編曲：<%= @song.arranger || "－" %></p>
      </div>
      <% if user_signed_in? %>
        <% if @user_review.present? %>
          <%= link_to edit_review_path(@user_review), class: "btn btn-primary text-base-100 px-6" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.862 3.487a2.25 2.25 0 1 1 3.182 3.182L7.5 19.213l-3.682.5.5-3.682 12.544-12.544z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 10.5V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V6.75A.75.75 0 0 1 3.75 6H14" />
            </svg>
            レビューを編集
          <% end %>
        <% else %>
          <%= link_to new_song_review_path(@song), class: "btn btn-primary text-base-100 px-6" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            レビューを投稿
          <% end %>
        <% end %>
      <% end %>
    </div>

    <% if @reviews.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <% @reviews.each do |review| %>
          <div class="card bg-base-100 border border-base-300 rounded-lg overflow-hidden" data-controller="review-chart">
            <!-- グラフエリア -->
            <div class="bg-base-200 p-2 flex items-center justify-center" style="height: 180px;">
              <div style="width: 100%; height: 100%; max-width: 180px; max-height: 180px;">
                <canvas
                  data-review-chart-target="canvas"
                  data-tempo="<%= review.tempo_rating %>"
                  data-fingering="<%= review.fingering_technique_rating %>"
                  data-plucking="<%= review.plucking_technique_rating %>"
                  data-expression="<%= review.expression_rating %>"
                  data-memorization="<%= review.memorization_rating %>"
                ></canvas>
              </div>
            </div>

            <!-- カード情報 -->
            <div class="card-body p-3">
              <h3 class="text-neutral mb-1">投稿者：<%= review.user.name %></h3>
              <p class="text-text-neutral mb-1">投稿日：<%= review.created_at.strftime('%Y/%m/%d') %></p>
              <div class="flex items-center gap-1 mb-1">
                <span class="text-neutral">総合難易度：</span>
                <div class="flex items-center">
                  <div class="rating rating-xs">
                    <% (1..5).each do |rating| %>
                      <% if rating == review.overall_rating %>
                        <div class="mask mask-star-2 bg-orange-400" aria-label="<%= rating %> star" aria-current="true"></div>
                      <% else %>
                        <div class="mask mask-star-2 bg-orange-400" aria-label="<%= rating %> star"></div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>

              <div class="mt-1">
                <div class="flex gap-2 items-center">
                  <%= link_to "詳細を見る", review_path(review), class: "btn btn-primary text-base-100 flex-1" %>
                  <% if user_signed_in? && current_user == review.user %>
                    <div class="tooltip" data-tip="編集">
                      <%= link_to edit_review_path(review), class: "btn btn-sm btn-primary text-base-100 w-10 h-10 min-h-0 p-0 flex items-center justify-center", aria: { label: "レビューを編集" } do %>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.862 3.487a2.25 2.25 0 1 1 3.182 3.182L7.5 19.213l-3.682.5.5-3.682 12.544-12.544z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 10.5V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V6.75A.75.75 0 0 1 3.75 6H14" />
                        </svg>
                      <% end %>
                    </div>
                    <div data-controller="auto-modal">
                      <div class="tooltip" data-tip="削除">
                        <button data-action="auto-modal#show" class="btn btn-sm btn-error text-base-100 w-10 h-10 min-h-0 p-0 flex items-center justify-center" aria-label="レビューを削除">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.74 9l-.346 9m-4.788 0L9.26 9m11.21-3.48H3.53m16.94 0l-.46 11.381a2.25 2.25 0 0 1-2.245 2.119H7.235a2.25 2.25 0 0 1-2.245-2.12L4.53 5.52m16.94 0h-4.636a2.25 2.25 0 0 1-2.121-1.515l-.427-1.282a2.25 2.25 0 0 0-2.121-1.515h-2.25A2.25 2.25 0 0 0 8.79 2.723l-.427 1.282A2.25 2.25 0 0 1 6.242 5.52H1.5" />
                          </svg>
                        </button>
                      </div>
                      <dialog class="modal" data-auto-modal-target="dialog">
                        <div class="modal-box">
                          <h3 class="font-bold text-lg mb-4">レビューの削除</h3>
                          <p class="py-4">レビューを削除すると元に戻せません。削除してもよろしいですか？</p>
                          <div class="modal-action">
                            <form method="dialog">
                              <button class="btn">キャンセル</button>
                            </form>
                            <%= button_to "削除する",
                              review_path(review),
                              method: :delete,
                              class: "btn btn-error text-base-100",
                              form: { data: { action: "submit->auto-modal#hide" } } %>
                          </div>
                        </div>
                        <form method="dialog" class="modal-backdrop">
                          <button>close</button>
                        </form>
                      </dialog>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-12">
        <p class="text-2xl text-neutral mb-4">まだレビューが投稿されていません</p>

        <% if user_signed_in? %>
          <%= link_to "最初のレビューを投稿する", new_song_review_path(@song), class: "btn btn-primary text-base-100" %>
        <% else %>
          <p class="text-base text-neutral mb-4">レビューを追加するには、ログインまたは新規登録が必要です</p>
          <%= link_to "ログイン / 新規登録", new_user_session_path, class: "btn btn-primary text-base-100" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
