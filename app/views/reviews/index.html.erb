<%= content_for(:title, t(".title")) %>

<div class="flex-1 px-4 py-8 md:py-12 lg:py-16">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4 mb-8 md:mb-12">
      <%= render "song_header", song: @song, title: "レビュー一覧" %>
      <div class="flex-shrink-0">
        <% if user_signed_in? %>
          <% if @user_review.present? %>
            <%= link_to edit_review_path(@user_review), class: "btn btn-primary text-base-100 px-6" do %>
              <%= inline_svg_tag("pencil.svg") %>レビューを編集
            <% end %>
          <% else %>
            <%= link_to new_song_review_path(@song), class: "btn btn-primary text-base-100 px-6" do %>
              <%= inline_svg_tag("plus.svg") %>レビューを投稿
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>

    <% if @reviews.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <% @reviews.each do |review| %>
          <div class="card bg-base-100 border border-base-300 rounded-lg overflow-hidden" data-controller="review-chart">
            <!-- グラフエリア -->
            <div class="bg-base-200 p-2 flex items-center justify-center" style="height: 180px;">
              <div style="width: 100%; height: 100%; max-width: 180px; max-height: 180px;">
                <canvas
                  data-review-chart-target="canvas"
                  data-tempo="<%= review.tempo_rating %>"
                  data-fingering="<%= review.fingering_technique_rating %>"
                  data-plucking="<%= review.plucking_technique_rating %>"
                  data-expression="<%= review.expression_rating %>"
                  data-memorization="<%= review.memorization_rating %>"
                ></canvas>
              </div>
            </div>

            <div class="card-body p-3">
              <h3 class="text-neutral mb-1">投稿者：<%= review.user.name %></h3>
              <p class="text-text-neutral mb-1">投稿日：<%= format_date(review.created_at) %></p>
              <div class="flex items-center gap-1 mb-1">
                <span class="text-neutral">総合難易度：</span>
                <%= star_rating_display(review.overall_rating, size: "xs") %>
              </div>

              <div class="mt-1">
                <div class="flex gap-2 items-center">
                  <%= link_to "詳細を見る", review_path(review), class: "btn btn-primary text-base-100 flex-1" %>
                  <% if user_signed_in? && current_user == review.user %>
                    <div class="tooltip" data-tip="編集">
                      <%= link_to edit_review_path(review), class: "btn btn-sm btn-primary text-base-100 w-10 h-10 min-h-0 p-0 flex items-center justify-center", aria: { label: "レビューを編集" } do %>
                        <%= inline_svg_tag("pencil.svg") %>
                      <% end %>
                    </div>
                    <%= render "delete_modal", review: review do %>
                      <div class="tooltip" data-tip="削除">
                        <button data-action="auto-modal#show" class="btn btn-sm btn-error text-base-100 w-10 h-10 min-h-0 p-0 flex items-center justify-center" aria-label="レビューを削除">
                          <%= inline_svg_tag("trash.svg") %>
                        </button>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-12">
        <p class="text-2xl text-neutral mb-4">まだレビューが投稿されていません</p>

        <% if user_signed_in? %>
          <%= link_to "最初のレビューを投稿する", new_song_review_path(@song), class: "btn btn-primary text-base-100" %>
        <% else %>
          <p class="text-base text-neutral mb-4">レビューを追加するには、ログインまたは新規登録が必要です</p>
          <%= link_to "ログイン / 新規登録", new_user_session_path, class: "btn btn-primary text-base-100" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
