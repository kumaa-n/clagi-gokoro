<div class="flex-1 px-4 py-8 md:py-12 lg:py-16">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4 mb-6 md:mb-8">
      <div class="min-w-0">
        <h2 class="text-2xl md:text-3xl text-primary font-semibold mb-4 break-words"><%= page_title %></h2>
        <p class="text-xl md:text-2xl text-primary font-semibold mb-2 break-words"><%= song.title %></p>
        <p class="text-base md:text-xl text-primary break-words">作曲：<%= song.composer_or_dash %></p>
        <p class="text-base md:text-xl text-primary break-words">編曲：<%= song.arranger_or_dash %></p>
      </div>
      <div class="flex gap-2 flex-shrink-0">
        <%= link_to song_reviews_path(song), class: "btn btn-ghost" do %>
          <%= inline_svg_tag("arrow-left.svg") %>一覧へ
        <% end %>
      </div>
    </div>

    <% form_url = review.persisted? ? review_path(review) : song_reviews_path(song) %>
    <%= form_with model: review, url: form_url, data: { controller: "review-form" } do |f| %>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-6">
          <div class="bg-base-100 p-6 rounded-lg border border-base-300">
            <h3 class="text-xl font-semibold mb-6">各項目の評価</h3>

            <%= render "shared/error_message", object: f.object %>

            <% tempo_description = capture do %>
              <p class="text-neutral">曲の速さやリズムの取りやすさ、安定したテンポ維持の難易度を意識して評価してください。</p>
              <ul class="space-y-1">
                <li><span class="font-semibold">★1</span>：テンポはゆっくり（60～80 bpm）。一定のビートを保ちやすく、拍感を掴みやすい。</li>
                <li><span class="font-semibold">★2</span>：テンポは中程度（80～100 bpm）。落ち着いた速さで、適度な緊張感がある。</li>
                <li><span class="font-semibold">★3</span>：テンポは標準（100～120 bpm）。速さの変化に対応しながら、安定したリズム維持が求められる。</li>
                <li><span class="font-semibold">★4</span>：テンポは速め（120～140 bpm）。細かなリズムやシンコペーションを正確に刻む必要がある。</li>
                <li><span class="font-semibold">★5</span>：高速テンポ（140 bpm以上）。体力・集中力を要し、長時間の正確なリズム維持が難しい。</li>
              </ul>
            <% end %>

            <% fingering_description = capture do %>
              <p class="text-neutral">ポジション移動や押弦の複雑さ、左手の安定感を基準に判断しましょう。</p>
              <ul class="space-y-1">
                <li><span class="font-semibold">★1</span>：オープンポジション中心。ポジション移動やセーハはほぼなし。</li>
                <li><span class="font-semibold">★2</span>：短いポジション移動や部分セーハが登場。基本フォームを保てれば対応可能。</li>
                <li><span class="font-semibold">★3</span>：5〜7ポジションへの移動、全セーハ、スラーを組み合わせる場面が増える。</li>
                <li><span class="font-semibold">★4</span>：高ポジションへの頻繁な移動やストレッチ、連続スライドが要求される。</li>
                <li><span class="font-semibold">★5</span>：広範囲の跳躍移動や複雑な運指分割、高速ポジションチェンジを正確にこなす必要がある。</li>
              </ul>
            <% end %>

            <% plucking_description = capture do %>
              <p class="text-neutral">右手の独立性、アルペジオや特殊奏法など弦を弾く技術の難度を評価してください。</p>
              <ul class="space-y-1">
                <li><span class="font-semibold">★1</span>：単音メロディーや基本的なアルペジオ。右手の独立性はほぼ不要。</li>
                <li><span class="font-semibold">★2</span>：単純な分散和音やベース音との同時発音。右手の指替えがゆっくり行える。</li>
                <li><span class="font-semibold">★3</span>：メロディー・ベース・内声を同時に扱い、指替えや弦移動が連続する。</li>
                <li><span class="font-semibold">★4</span>：高速アルペジオ、トレモロ、ラスゲアード風の奏法など高度なコントロールが求められる。</li>
                <li><span class="font-semibold">★5</span>：多声部を完全に独立して扱い、音色・ダイナミクスの細密なコントロールと特殊奏法を織り交ぜる。</li>
              </ul>
            <% end %>

            <% expression_description = capture do %>
              <p class="text-neutral">フレーズの抑揚や音色変化、感情表現の幅広さをどれだけ求められるかで判断してください。</p>
              <ul class="space-y-1">
                <li><span class="font-semibold">★1</span>：基本的な強弱変化のみ。フレーズごとの自然な山と谷を作れば十分。</li>
                <li><span class="font-semibold">★2</span>：緩やかなルバートやアクセント付けを織り交ぜ、曲想を整える必要がある。</li>
                <li><span class="font-semibold">★3</span>：フレーズ内での音色変化、ビブラートの活用など中程度の表現幅が求められる。</li>
                <li><span class="font-semibold">★4</span>：多声部のバランス調整や微細なダイナミクス操作で立体感を作る。</li>
                <li><span class="font-semibold">★5</span>：高度な解釈力と即応性が必要。多彩な音色変化・緻密なニュアンスを瞬時に切り替える。</li>
              </ul>
            <% end %>

            <% memorization_description = capture do %>
              <p class="text-neutral">曲の構造理解や暗譜の負担感、セクションの複雑さを基準に評価してください。</p>
              <ul class="space-y-1">
                <li><span class="font-semibold">★1</span>：短い楽曲で反復が多い。A-Bなど単純な構成で暗譜しやすい。</li>
                <li><span class="font-semibold">★2</span>：2〜3セクションの構成。簡単な変化や転調があり、流れを把握すれば覚えられる。</li>
                <li><span class="font-semibold">★3</span>：複数テーマや変奏を含み、セクションごとの役割を整理する必要がある。</li>
                <li><span class="font-semibold">★4</span>：長尺で展開が多彩。転調や再現部の位置関係を理解しないと記憶が難しい。</li>
                <li><span class="font-semibold">★5</span>：高度に複雑な構成。多数のモチーフ・転調・リズム変化を分析して整理する必要がある。</li>
              </ul>
            <% end %>

            <%= render "rating_field",
              f: f,
              label: "テンポ",
              field: :tempo_rating,
              description: tempo_description %>

            <%= render "rating_field",
              f: f,
              label: "運指技巧",
              field: :fingering_technique_rating,
              description: fingering_description %>

            <%= render "rating_field",
              f: f,
              label: "弾弦技巧",
              field: :plucking_technique_rating,
              description: plucking_description %>

            <%= render "rating_field",
              f: f,
              label: "表現力",
              field: :expression_rating,
              description: expression_description %>

            <%= render "rating_field",
              f: f,
              label: "暗譜・構成理解",
              field: :memorization_rating,
              description: memorization_description %>

            <div class="mb-6">
              <%= f.label :summary, "コメント（任意）", class: "label font-semibold" %>
              <%= f.text_area :summary, rows: 6, class: "textarea textarea-bordered w-full resize-none", placeholder: "演奏についてのコメントを入力してください" %>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-base-100 p-6 rounded-lg border border-base-300">
            <h3 class="text-xl font-semibold mb-4">評価プレビュー</h3>
            <div class="bg-base-200 rounded-lg p-8 flex items-center justify-center min-h-[300px]">
              <canvas data-review-form-target="chart" class="max-w-full"></canvas>
            </div>
          </div>

          <div class="bg-base-100 p-6 rounded-lg border border-base-300 space-y-6">
            <h3 class="text-xl font-semibold">評価ガイドライン</h3>

            <% general_guidelines = [
              { stars: 1, label: "とても易しい", description: "初心者でも弾ける。基本的な技術と短い練習時間で仕上げられる。" },
              { stars: 2, label: "やや易しい", description: "基礎を身につけた初級者向け。落ち着いて取り組めば習得できる。" },
              { stars: 3, label: "普通", description: "標準的な中級レパートリー。計画的な練習で確実に仕上げられる。" },
              { stars: 4, label: "やや難しい", description: "上級者入口。高度な技術や表現力が必要で、重点的な練習が必要。" },
              { stars: 5, label: "とても難しい", description: "最上級レベル。豊富な演奏経験と高い集中力、総合的な技術を要する。" }
            ] %>

            <div class="space-y-3 text-sm">
              <% general_guidelines.each do |guide| %>
                <div class="flex items-start gap-3">
                  <div class="rating rating-sm mt-1">
                    <% 5.times do |star| %>
                      <% if star + 1 == guide[:stars] %>
                        <div class="mask mask-star-2 bg-orange-400" aria-label="<%= star + 1 %> star" aria-current="true"></div>
                      <% else %>
                        <div class="mask mask-star-2 bg-orange-400" aria-label="<%= star + 1 %> star"></div>
                      <% end %>
                    <% end %>
                  </div>
                  <div>
                    <p class="font-semibold"><%= guide[:label] %></p>
                    <p><%= guide[:description] %></p>
                  </div>
                </div>
              <% end %>
            </div>

          </div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-center gap-4 mt-8">
        <%= link_to "キャンセル", song_reviews_path(song), class: "btn px-8" %>
        <%= f.submit submit_label, class: "btn btn-primary text-base-100 px-8" %>
      </div>
    <% end %>
  </div>
</div>
