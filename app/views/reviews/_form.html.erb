<div class="flex-1 px-4 py-8 md:py-12 lg:py-16">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4 mb-6 md:mb-8">
      <%= render "song_header", song: song, title: page_title %>
      <div class="flex gap-2 flex-shrink-0">
        <%= link_to song_reviews_path(song), class: "btn btn-ghost" do %>
          <%= inline_svg_tag("arrow-left.svg") %>一覧へ
        <% end %>
      </div>
    </div>

    <% form_url = review.persisted? ? review_path(review) : song_reviews_path(song) %>
    <%= form_with model: review, url: form_url, data: { controller: "review-form" } do |f| %>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-6">
          <div class="bg-base-100 p-6 rounded-lg border border-base-300">
            <h3 class="text-xl font-semibold mb-6">各項目の評価</h3>

            <%= render "shared/error_message", object: f.object %>

            <% rating_fields_data.each do |rating| %>
              <% description = capture do %>
                <p class="text-neutral"><%= rating[:intro] %></p>
                <ul class="space-y-1">
                  <% rating[:criteria].each_with_index do |criterion, index| %>
                    <li><span class="font-semibold">★<%= index + 1 %></span>：<%= criterion %></li>
                  <% end %>
                </ul>
              <% end %>

              <%= render "rating_field",
                f: f,
                label: rating[:label],
                field: rating[:field],
                description: description %>
            <% end %>

            <div class="mb-6">
              <%= f.label :summary, "コメント（任意）", class: "label font-semibold" %>
              <%= f.text_area :summary, rows: 6, class: "textarea textarea-bordered w-full resize-none", placeholder: "曲についてのコメントを入力してください" %>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-base-100 p-6 rounded-lg border border-base-300">
            <h3 class="text-xl font-semibold mb-4">評価プレビュー</h3>
            <div class="bg-base-200 rounded-lg p-8 flex items-center justify-center min-h-[300px]">
              <canvas data-review-form-target="chart" class="max-w-full"></canvas>
            </div>
          </div>

          <div class="bg-base-100 p-6 rounded-lg border border-base-300 space-y-6">
            <h3 class="text-xl font-semibold">評価ガイドライン</h3>

            <div class="space-y-3 text-sm">
              <% general_guidelines_data.each do |guide| %>
                <div class="flex items-start gap-3">
                  <div class="mt-1">
                    <%= star_rating_display(guide[:stars], size: "sm") %>
                  </div>
                  <div>
                    <p class="font-semibold"><%= guide[:label] %></p>
                    <p><%= guide[:description] %></p>
                  </div>
                </div>
              <% end %>
            </div>

          </div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-center gap-4 mt-8">
        <%= link_to "キャンセル", song_reviews_path(song), class: "btn px-8" %>
        <%= f.submit submit_label, class: "btn btn-primary text-base-100 px-8" %>
      </div>
    <% end %>
  </div>
</div>
