<div class="flex-1 bg-base-200/50">
  <div class="pt-4 md:pt-6 mb-6">
    <div class="container mx-auto px-4">
      <%= render "shared/breadcrumbs" %>
    </div>
  </div>

  <div class="pb-8 md:pb-12 lg:pb-16">
    <div class="container mx-auto px-4">

    <%# ページヘッダー：曲情報とナビゲーション %>
    <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-6 mb-8 md:mb-12 border-b border-primary/10 pb-6">
      <div class="flex-1">
        <%= render "song_header", song: song, title: page_title %>
      </div>
      <div class="flex gap-3 mt-4 md:mt-0">
        <%= link_to song_reviews_path(song),
                    class: "btn btn-ghost text-primary hover:bg-primary/10 rounded-full px-3 gap-2" do %>
          <%= inline_svg_tag("back.svg", class: "fill-current w-5 h-5") %>レビュー一覧へ
        <% end %>
      </div>
    </div>

    <%# フォーム本体 %>
    <%= form_with model: review,
                  url: (review.persisted? ? review_path(review) : song_reviews_path(song)),
                  data: { controller: "review-form" } do |f| %>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <%# 左側：評価入力フォーム %>
        <div class="space-y-6">
          <div class="card bg-white">
            <div class="card-body p-6 md:p-8">
              <h3 class="text-xl font-serif font-medium text-primary mb-6">各項目の評価</h3>

              <%= render "shared/error_message", object: f.object %>

              <%# 各評価項目 %>
              <% rating_fields_data.each do |rating| %>
                <% description = capture do %>
                  <p class="text-neutral/80 text-sm mb-2"><%= rating[:intro] %></p>
                  <ul class="space-y-1 text-sm text-neutral/70">
                    <% rating[:criteria].each_with_index do |criterion, index| %>
                      <li><span class="font-semibold text-primary">★<%= index + 1 %></span>：<%= criterion %></li>
                    <% end %>
                  </ul>
                <% end %>

                <%= render "rating_field",
                  f: f,
                  label: rating[:label],
                  field: rating[:field],
                  description: description %>
              <% end %>

              <%# タグ選択 %>
              <div class="mt-2"
                   data-controller="tags"
                   data-tags-whitelist-value="<%= ReviewTags::AVAILABLE_TAGS.to_json %>"
                   data-tags-max-tags-value="<%= ReviewTags::MAX_TAGS_PER_REVIEW %>">
                <%= f.label :tags, "タグ（最大#{ReviewTags::MAX_TAGS_PER_REVIEW}個）", class: "font-serif font-medium text-primary text-base mb-2" %>
                <%= f.hidden_field :tags, value: review.tags.to_json %>
                <input type="text"
                       value="<%= review.tags.join(',') %>"
                       placeholder="クリックしてタグを選択"
                       class="input input-bordered w-full bg-base-50 focus:bg-white transition-colors"
                       data-tags-target="input" />
              </div>

              <%# 投稿者コメント %>
              <div class="mt-4"
                   data-controller="char-counter"
                   data-char-counter-max-value="<%= Review::SUMMARY_MAX_LENGTH %>"
                   data-char-counter-exclude-line-breaks-value="true">
                <%= f.label :summary, class: "font-serif font-medium text-primary text-base mb-2" %>
                <%= f.text_area :summary,
                                rows: 10,
                                placeholder: "レビューについてのコメントを入力してください",
                                class: "textarea textarea-bordered w-full resize-none bg-base-50 focus:bg-white transition-colors",
                                data: {
                                  char_counter_target: "input",
                                  action: "input->char-counter#updateCount focus->char-counter#markAsTouched"
                                } %>
                <div class="text-right text-sm text-neutral/60 mt-1">
                  <span data-char-counter-target="counter">0</span> / <%= Review::SUMMARY_MAX_LENGTH %>文字
                </div>
              </div>
            </div>
          </div>
        </div>

        <%# 右側：プレビューとガイドライン %>
        <div class="space-y-6">
          <div class="card bg-white sticky top-24">
            <div class="card-body p-6 md:p-8">

              <%# レーダーチャートによる評価プレビュー %>
              <h3 class="text-xl font-serif font-medium text-primary mb-6 text-center">評価プレビュー</h3>
              <div class="bg-base-100 rounded-xl p-4 md:p-6 flex items-center justify-center aspect-square relative mb-8 max-w-full">
                <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                  <%= inline_svg_tag("chart-bg.svg", class: "w-48 h-48 text-primary") rescue nil %>
                </div>
                <div class="relative z-10 w-full h-full">
                  <canvas data-review-form-target="chart" class="max-w-full max-h-full"></canvas>
                </div>
              </div>

              <%# 評価ガイドライン %>
              <div class="bg-base-50 rounded-xl p-6 border border-base-200/60">
                <h3 class="text-lg font-serif font-medium text-primary mb-4 flex items-center gap-2">
                  <%= inline_svg_tag("info.svg") %> 評価ガイドライン
                </h3>

                <div class="space-y-4 text-sm">
                  <% general_guidelines_data.each do |guide| %>
                    <div class="flex items-start gap-3">
                      <div class="mt-0.5 shrink-0">
                        <%= star_rating_display(guide[:stars], size: "sm") %>
                      </div>
                      <div>
                        <p class="font-medium text-primary mb-0.5"><%= guide[:label] %></p>
                        <p class="text-neutral/70 text-xs leading-relaxed"><%= guide[:description] %></p>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="flex flex-col gap-3 mt-8">
                <%= f.submit submit_label,
                             class: "btn btn-primary w-full shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5 rounded-full" %>
                <%= link_to "キャンセル",
                            review.persisted? ? review_path(review) : song_reviews_path(song),
                            class: "btn btn-outline w-full rounded-full px-8" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    </div>
  </div>
</div>
