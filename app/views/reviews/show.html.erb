<% breadcrumb :review, @review %>
<%= content_for(:title, t(".title")) %>

<%
  # カスタムOGP設定（X共有用）
  review_title = "レビュー：#{@song.title}"
  review_description = @review.summary.present? ? truncate(@review.summary, length: 100) : "#{@song.title}のレビュー"

  set_meta_tags(
    title: review_title,
    og: {
      title: review_title,
      description: review_description,
      type: "article",
      url: review_url(@review)
    },
    twitter: {
      title: review_title,
      description: review_description
    }
  )
%>

<div class="flex-1 bg-base-200/50">
  <div class="pt-4 md:pt-6 mb-6">
    <div class="container mx-auto px-4">
      <%= render "shared/breadcrumbs" %>
    </div>
  </div>

  <div class="pb-8 md:pb-12 lg:pb-16">
    <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-6 mb-8 md:mb-12 border-b border-primary/10 pb-6">
      <div class="flex-1">
        <%= render "song_header", song: @song, title: "レビュー詳細" %>
      </div>

      <%# ボタン類 %>
      <div class="flex flex-col md:flex-row gap-3 mt-4 md:mt-0 items-start">
        <%= link_to song_reviews_path(@song), class: "btn btn-ghost text-primary hover:bg-primary/10 rounded-full px-2 gap-2" do %>
          <%= inline_svg_tag("back.svg", class: "fill-current w-5 h-5") %>レビュー一覧へ
        <% end %>
        <% if user_signed_in? && current_user == @review.user %>
          <div class="flex gap-3">
            <%= link_to edit_review_path(@review), class: "btn btn-primary shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5 rounded-full px-4 gap-2" do %>
              <%= inline_svg_tag("edit.svg", class: "fill-current w-5 h-5") %>編集
            <% end %>
            <%= render "delete_modal", review: @review do %>
              <button data-action="auto-modal#show" class="btn btn-error text-base-100 shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5 rounded-full px-4 gap-2">
                <%= inline_svg_tag("delete.svg", class: "fill-current w-5 h-5") %>削除
              </button>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <%# メイン情報（左側） %>
      <div class="space-y-8">
        <%# 投稿者情報と総合評価 %>
        <div class="card bg-white p-6 md:p-8">
          <div class="flex flex-col gap-4">
            <%= link_to user_path(@review.user.name), class: "flex items-center gap-3 group self-start" do %>
              <div class="avatar placeholder">
                <div class="bg-primary text-white rounded-full w-12 h-12 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
                  <span class="text-lg font-medium"><%= @review.user.name[0].upcase %></span>
                </div>
              </div>
              <div class="flex flex-col">
                <span class="text-sm text-neutral/60 font-medium">投稿者</span>
                <span class="text-base font-medium text-primary group-hover:underline group-hover:text-primary/80 transition-colors"><%= @review.user.name %></span>
              </div>
            <% end %>

            <div class="flex items-center gap-2">
              <span class="text-sm text-neutral/60 font-medium">投稿日</span>
              <p class="text-base text-neutral/80"><%= format_date(@review.created_at) %></p>
            </div>

            <div class="bg-base-200/50 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:text-align-center gap-3 self-start">
              <span class="text-primary font-serif font-medium text-lg">総合難易度</span>
              <div class="flex items-center gap-2">
                <%= star_rating_display(@review.overall_rating, size: "md") %>
                <span class="text-2xl font-bold text-primary"><%= format_overall_rating(@review.overall_rating) %></span>
              </div>
            </div>
          </div>
        </div>

        <%# 各項目の評価 %>
        <div class="card bg-white">
          <div class="card-body p-6 md:p-8">
            <h3 class="text-xl font-serif font-medium text-primary mb-6">各項目の評価</h3>
            <div class="space-y-6">
              <% rating_display_data(@review).each do |item| %>
                <%= render "rating_item", label: item[:label], rating: item[:rating], description: item[:description], criteria: item[:criteria] %>
              <% end %>
            </div>

            <%# 投稿者コメント %>
            <div class="mt-2">
              <label class="block font-serif font-medium text-primary text-base mb-2">投稿者コメント</label>
              <div class="textarea textarea-bordered w-full bg-base-50 break-words" style="height: 16rem; max-height: 16rem; overflow-y: auto; white-space: pre-wrap;"><%=
                @review.summary.presence || "コメントはありません"
              %></div>
            </div>

            <%# 参考動画URL %>
            <% if @review.reference_url.present? %>
              <div class="mt-2">
                <label class="block font-serif font-medium text-primary text-base mb-2">参考動画URL</label>
                <div class="flex items-center gap-2">
                  <%= link_to @review.reference_url, @review.reference_url, target: "_blank", rel: "noopener noreferrer", class: "link link-primary truncate" %>
                </div>
              </div>
            <% end %>

            <%# タグ %>
            <% if @review.tags.present? %>
              <div class="mt-2">
                <label class="block font-serif font-medium text-primary text-base mb-2">タグ</label>
                <div class="flex flex-wrap gap-2">
                  <%= render_tags(@review.tags) %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%# チャート・アクション（右側） %>
      <div class="space-y-8">
        <%# チャート %>
        <div class="card bg-white sticky top-24">
          <div class="card-body p-6 md:p-8">
            <h3 class="text-xl font-serif font-medium text-primary mb-4 text-center">評価チャート</h3>
            <div class="bg-base-100 rounded-xl p-4 md:p-6 flex items-center justify-center aspect-square relative max-w-full" data-controller="review-detail-chart">
              <div class="relative z-10 w-full h-full">
                <canvas
                  data-review-detail-chart-target="canvas"
                  class="max-w-full max-h-full"
                  data-tempo="<%= @review.tempo_rating %>"
                  data-fingering="<%= @review.fingering_technique_rating %>"
                  data-plucking="<%= @review.plucking_technique_rating %>"
                  data-expression="<%= @review.expression_rating %>"
                  data-memorization="<%= @review.memorization_rating %>"
                ></canvas>
              </div>
            </div>

            <%# ボタン類 %>
            <div class="mt-6 pt-6 border-t border-base-200">
              <div class="flex gap-3 justify-center">
                <%= render "review_favorites/button", review: @review %>

                <%= link_to x_share_url(@review), target: "_blank", rel: "noopener noreferrer",
                   class: "btn gap-2 h-10 min-h-10 px-6 rounded-full shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300" do %>
                  <%= inline_svg_tag("x.svg", class: "w-5 h-5 fill-current") %>
                  <span class="whitespace-nowrap font-medium">Xで共有</span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
